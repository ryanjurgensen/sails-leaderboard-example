var compressor = require('node-minify'),
	async = require('async');


exports.compile=function(config,compilerCallback){
	
	var isProduction = config.appEnvironment=="production",
	isDevelopment = config.appEnvironment=="development";
	
	console.log("Compiling JS and CSS in " + config.appEnvironment + " mode into "+config.appPath+"...");
	var compileWaitTimer = setInterval(function(){console.log("Still compiling CSS/JS...")},1500);

	if (isProduction) {

		async.parallel([
		
			function(finishedCss){
				console.log("MINIFIYING CSS!!!");
				// Combine and minify css
				new compressor.minify({
					type: 'yui',
					fileIn: _mastCssFiles,
					fileOut: config.appPath+'/public/_target/app.css',
					callback: finishedCss
				});
			},
		
			function (finishedJs) {
				console.log("MINIFIYING JS!!!");
				// Combine and minify js
				new compressor.minify({
					type: 'gcc',
					fileIn: _mastJsFiles,
					fileOut: config.appPath+'/public/_target/app.js',
					callback: finishedJs
				})	
			}
			],function(outcome) {
				console.log("******* Finished compiling production assets ********",outcome);
				clearTimeout(compileWaitTimer);
				compilerCallback();
			})
	}

	else if (isDevelopment) {
		// Public access to /mast directory is only enabled in development mode
		// See express's app.configure() in main.js

		// We take advantage of that by directly linking to all of the necessary files
		clearTimeout(compileWaitTimer);
		compilerCallback();
	}

} 